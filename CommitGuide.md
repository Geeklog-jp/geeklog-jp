# プロジェクトのメンバーのためのコミットガイド #

本ドキュメントはプロジェクトのメンバーがコードをコミットするにあたっての手引きです。(完成版ではありません。)


---


## コミットする前に ##

予め、以下のことを行っておいてください。

  * [Mercurialの設定](SettingMercurial.md)に従って、必要があればMercurialの設定を行ってください。
  * [メーリングリスト](MailingList.md)に従って、変更の結果をメールで受けるようにしてください。(推奨)


---


## ソースのコミットの約束 ##

  1. ソースコードの更新は原則として開発用のブランチであるdefaultに対して行います。
  1. ブランチは安定版の保守や特定の開発目的に使用します。
    * 安定版は他の開発者に一声掛けてから、動作が確認されているものをコミットします。
    * 特定の開発目的のブランチは、そのブランチで開発を行っている方が原則としてコミットします。
    * 特定の開発版は最終的に開発用のdefaultにマージすることになりますが、マージにあたっては十分に議論を行った上で行ってください。
  1. MercurialではローカルリポジトリからGoogle Codeにpushするときに、他の開発者が先にpushしているとエラーとなります。この場合は、改めてGoogle Codeの変更をマージしてください。
  1. コミットのログは以下のようにしてください。
    * 最初の1行に変更のサマリーを書いてください。
    * 2行目を空行として、3行目から詳細なログを書いてください。
    * 詳細なログは100行くらいまで長くなっても構いません。
  1. 新しいファイルを追加するときは、そのファイル名に気をつけましょう。例えば、以下のような名前やパターンにマッチするファイルは使用しないようにしましょう。(まず、使うことはないと思いますが。)
```
    RCS     SCCS    CVS     CVS.adm
    RCSLOG  cvslog.*
    tags    TAGS
    .hg*     .make.state     .nse_depinfo
    *~      #*      .#*     ,*      _$*     *$
    *.old   *.bak   *.BAK   *.orig  *.rej   .del-*
    *.a     *.olb   *.o     *.obj   *.so    *.exe
    *.Z     *.elc   *.ln  
    core    *.core
```
  1. 本体のコードを直接変更した場合は、IssueでMaintainabilityのラベルを付加して、将来バージョンアップするときの作業の目安となるようにしましょう。
  1. 一通りの変更の後に、変更事項の概要を CHANGES.jp に記述しましょう。CHANGES.jpの変更は別にコミットするようにしてください。他のブランチへのマージの作業が容易となります。


---


### 変更のコミット ###

修正した内容をローカルリポジトリに登録するにはMercurialの`commit`で行います。

```
% hg commit
...
```

コミット時には CHANGES.jp の変更もひとまとめにして行いましょう。

### 変更のGoogle Codeへの反映 ###

ローカルリポジトリにコミットしただけでは、Google Codeのリポジトリに反映されません。Mercurialの`push`の実行が必要です。

```
% hg push
...
```


---


### pushのエラーの解決 ###

他の開発者がGoogle Codeのリポジトリに変更を既に`push`していると、`push`の処理はエラーとなります。この場合は以下のようにして変更をマージします。(以下は実際に試してはいないので、実際に起きたときを踏まえて書き直す必要があるかもしれません。)

  1. Mercurialの`pull`でGoogle Codeの変更をローカルリポジトリに取り込みます。
```
% hg pull
```
  1. Mercurialの`merge`で両者を作業領域にマージします。
```
% hg merge
```
  1. マージで衝突が発生した場合は該当するファイルは、Mercurialの`resolv -l`で確認できます。
```
% hg resolve -l
U foo.php
```
  1. 衝突が起きたファイルを編集して修正します。
  1. 衝突が解消できましたら、Mercurialの`resolve -m`を使って解消済みにします。
```
% hg resolve -m foo.php
R foo.php
```
  1. 変更内容をMercurialの`diff`を使うなどして確認した上で、変更を有効にするためにコミットします。
```
% hg commit
...
```
  1. 改めて変更をGoogle CodeのリポジトリにMercurialの`push`で反映します。
```
% hg push
...
```



---


## こんなときどうする? ##

  * コミットのログに何を書いたらいいですか?

> コードに行った修正の内容をわかりやすく書きます。

  * コードにも変更点を書くべきですか?

  * 何か新しい処理を加えたような場合は、それを説明するコメントを記述すべきです。

  * 一方、過去のコードをコメントで残すとか、変更内容をコメントに記述する必要はありません。過去のコードは古いリビジョンと比較すればわかりますし、その際に余計な部分が少ないほど差分を比較したり、パッチとして本家に提供するときも適切な内容になります。

  * 変更内容はコミットのログに書くべきもので、コードそのものに記録を残すものではありません。

  * 間違ってファイルを削除してしまいました。

  * 直前のコミット合はMercurialの`revert`で直前のローカルリポジトリに対する操作を取り消せます。
  * この場合忘れずにMercurialの`push`を行って、Google Codeのリポジトリに反映してください。